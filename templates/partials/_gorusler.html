{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/base_css/_gorusler.css' %}">
{% endblock %}

{% block content %}
<section>
<div class="container-fluid gorusler-wrapper">
  <div class="row">
    <div class="col-12 col-md-2">
      
    </div>

    <div class="col-12 col-md-10">
      <div class="row gorusler-logo-slogan align-items-center">
        <div class="col-12 col-md-6 gorusler-logo-baslik_wrapper">
          <div class="logo-container">
            <img src="{% static 'img/grilogo.svg' %}" alt="Logo" class="logo-img">
          </div>
          <span class="gorusler-logo-title">DEĞERLİ GÖRÜŞLER</span>
        </div>
        <div class="col-12 col-md-6 gorusler-baslik-slogan">
          <p class="gorusler-slogan-text">Müşterilerimizin geri bildirimleri, mükemmeliyet anlayışımızı şekillendiriyor. Deneyimlerini okuyun ve Akliva’nın inşaat sektöründe neden güvenilen bir isim olduğunu keşfedin.</p>
        </div>
      </div>

      <div class="slider-progress-wrapper">
        <div class="buyuk-slider-container">
          <div class="buyuk-slider-card" id="buyukKart"></div>
        </div>

        <div class="kucuk-slider-wrapper">
          <div class="kusuk-slider-card-scroll" id="kucukSlider"></div>

          <div class="progress-arrows progress-desktop">
            <div class="progress-bar">
              <div class="progress-bar-fill"></div>
            </div>
            <img src="{% static 'img/sliderSol.png' %}" alt="Sol Ok" class="arrow prev" id="solOk">
            <img src="{% static 'img/sliderSag.png' %}" alt="Sağ Ok" class="arrow next" id="sagOk">
          </div>


        </div>
            <div class="progress-arrows progress-mobile">
              <div class="progress-bar">
                <div class="progress-bar-fill"></div>
              </div>
              <img src="{% static 'img/sliderSol.png' %}" alt="Sol Ok" class="arrow prev" id="solOkMobile">
              <img src="{% static 'img/sliderSag.png' %}" alt="Sağ Ok" class="arrow next" id="sagOkMobile">
            </div>


        
      </div>
    </div>
  </div>
</div>
</section>
{% endblock %}

{% block extra_js %}
<script type="application/json" id="gorusler-json">
  {{ gorusler_json|safe }}
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  console.log("Slider JS başladı");

  const buyukKart = document.getElementById("buyukKart");
  const kucukSlider = document.getElementById("kucukSlider");
  const nextBtn = document.getElementById("sagOk");
  const prevBtn = document.getElementById("solOk");
  const progressFills = document.querySelectorAll(".progress-bar-fill");
  const gorusler = JSON.parse(document.getElementById("gorusler-json").textContent);
  const toplamKartSayisi = gorusler.length;

  let aktifIndex = 0;
  let silinenKartlar = [];

  function kisaMesaj(metin, limit = 100) {
    return metin.length > limit ? metin.slice(0, limit) + "..." : metin;
  }

  function updateProgressBar() {
  const oran = ((aktifIndex + 1) / toplamKartSayisi) * 100;
  document.querySelectorAll(".progress-bar-fill").forEach(fill => {
    fill.style.width = `${oran}%`;
  });
}

  function renderBuyukKart(index) {
    const item = gorusler[index];
    buyukKart.innerHTML = `
      <img src="{% static 'img/gorusler-personel-sari.svg' %}" class="personel-img">
      <div class="ad">${item.ad}</div>
      <div class="meslek-sehir">${item.meslek} • ${item.sehir}</div>
      <div class="yildizlar">${renderYildiz(item.yildiz_sayisi)}</div>
      <div class="mesaj">${kisaMesaj(item.mesaj)}</div>
      <div class="tarih">${item.tarih}</div>
    `;
  }

  function renderYildiz(sayi) {
    let html = "";
    for (let i = 1; i <= 5; i++) {
      const src = i <= sayi ? "{% static 'img/sari-yildiz.svg' %}" : "{% static 'img/sari-yildiz1.svg' %}";
      html += `<img src="${src}" alt="Yıldız">`;
    }
    return html;
  }

  function renderKucukKart(item) {
    const div = document.createElement("div");
    div.className = "kucuk-card";
    div.innerHTML = `
      <img src="{% static 'img/gorusler-person-gri.svg' %}" class="person">
      <div class="ad">${item.ad}</div>
      <div class="meslek-sehir">${item.meslek} • ${item.sehir}</div>
      <div class="yildizlar">${renderYildiz(item.yildiz_sayisi)}</div>
      <div class="mesaj">${kisaMesaj(item.mesaj)}</div>
      <div class="tarih">${item.tarih}</div>
    `;
    return div;
  }

  gorusler.slice(1).forEach(item => {
    kucukSlider.appendChild(renderKucukKart(item));
  });

  nextBtn.addEventListener("click", () => {
    const kucukKartlar = kucukSlider.querySelectorAll(".kucuk-card");
    if (aktifIndex < gorusler.length - 1 && kucukKartlar.length > 0) {
      const silinecek = kucukKartlar[0];
      silinecek.classList.add("kaybol");

      setTimeout(() => {
        silinenKartlar.push(silinecek);
        kucukSlider.removeChild(silinecek);
        aktifIndex++;
        renderBuyukKart(aktifIndex);
        updateProgressBar();
      }, 300);
    }
  });

  prevBtn.addEventListener("click", () => {
    if (aktifIndex > 0 && silinenKartlar.length > 0) {
      const geriKart = silinenKartlar.pop();
      geriKart.classList.add("kaybol");
      kucukSlider.insertBefore(geriKart, kucukSlider.firstChild);

      void geriKart.offsetWidth;

      setTimeout(() => {
        geriKart.classList.remove("kaybol");
      }, 30);

      aktifIndex--;
      renderBuyukKart(aktifIndex);
      updateProgressBar();
    }
  });

  // Mobil oklar için yönlendirme
  document.getElementById("sagOkMobile")?.addEventListener("click", () => {
    nextBtn.click();
  });

  document.getElementById("solOkMobile")?.addEventListener("click", () => {
    prevBtn.click();
  });

  // Başlangıçta büyük kartı ve progress bar'ı yükle
  renderBuyukKart(0);
  updateProgressBar();

  // ✅ Sadece mobilde test için aktifIndex = 2 yap
  if (window.innerWidth <= 992) {
    aktifIndex = 2;
    renderBuyukKart(aktifIndex);
    updateProgressBar();
  }

  console.log("Gelen veri:", gorusler);
});
</script>
{% endblock %}
